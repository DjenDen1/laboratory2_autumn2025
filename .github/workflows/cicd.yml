name: CICD

on:
  push:
    branches: 
      - main

permissions:
  contents: write 

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Clean build directory
        run: |
          if (Test-Path build) {
            Remove-Item -Recurse -Force build
          }
      
      - name: Configure CMake
        run: cmake -S . -B build
        
      - name: Build with CMake
        run: cmake --build build --config Release

      - name: Create Windows release folder
        run: |
          mkdir windows-release
          copy build\Release\laboratory2.exe windows-release\
          copy ip_filter.tsv windows-release\
          echo "Windows release folder created"

      - name: List Windows release contents
        run: dir windows-release\

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-release
          path: windows-release/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean build directory
        run: rm -rf build

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Configure CMake
        run: cmake -S . -B build

      - name: Build project
        run: cmake --build build --config Release

      - name: Create Linux release folder
        run: |
          mkdir linux-release
          cp build/laboratory2 linux-release/
          cp ip_filter.tsv linux-release/
          chmod +x linux-release/laboratory2
          echo "Linux release folder created"

      - name: List Linux release contents
        run: ls -la linux-release/

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-release
          path: linux-release/

  create-release:
    needs: [build-windows, build-linux]  
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-release
          path: windows-release

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-release
          path: linux-release

      - name: Debug - List downloaded files
        run: |
          echo "Windows release contents:"
          ls -la windows-release/
          echo "Linux release contents:"
          ls -la linux-release/

      - name: Create release archives
        run: |
          # Создаем zip архив для Windows
          cd windows-release
          zip -r ../laboratory2-windows.zip .
          cd ..
          
          # Создаем tar.gz архив для Linux
          cd linux-release
          tar -czf ../laboratory2-linux.tar.gz .
          cd ..
          
          echo "Release archives created"
          ls -la *.zip *.tar.gz

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }} 
          draft: false
          prerelease: false
          files: |
            laboratory2-windows.zip
            laboratory2-linux.tar.gz
          body: |
            Laboratory 2 Release v${{ github.run_number }}
            
            Download Ready-to-Use Packages:
            
            For Windows:
            - Download laboratory2-windows.zip
            - Extract the archive
            - Run laboratory2.exe
            - Includes: laboratory2.exe + ip_filter.tsv
            
            For Linux:
            - Download laboratory2-linux.tar.gz  
            - Extract the archive: tar -xzf laboratory2-linux.tar.gz
            - Run: ./laboratory2
            - Includes: laboratory2 + ip_filter.tsv
            
            Quick Start:
            1. Download the package for your OS
            2. Extract to any folder
            3. Run the executable
            4. No additional files needed
            
            Build Info:
            - Build Number: ${{ github.run_number }}
            - Commit: ${{ github.sha }}