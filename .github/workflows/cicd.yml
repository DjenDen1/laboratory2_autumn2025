name: CICD

on:
  push:
    branches: 
      - main

permissions:
  contents: write 

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Verify ip_filter.tsv exists
        run: |
          if (Test-Path ip_filter.tsv) {
            echo "ip_filter.tsv found"
            Get-Content ip_filter.tsv | Select-Object -First 3
          } else {
            echo "ERROR: ip_filter.tsv not found!"
            dir
            exit 1
          }
      
      - name: Clean build directory
        run: |
          if (Test-Path build) {
            Remove-Item -Recurse -Force build
          }
      
      - name: Configure CMake
        run: cmake -S . -B build
        
      - name: Build with CMake
        run: cmake --build build --config Release

      - name: Create Windows release package
        run: |
          mkdir windows-package
          copy build\Release\laboratory2.exe windows-package\
          copy ip_filter.tsv windows-package\
          echo "Windows release package created"

      - name: List Windows release contents
        run: dir windows-package\

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-package
          path: windows-package/

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify ip_filter.tsv exists
        run: |
          if [ -f "ip_filter.tsv" ]; then
            echo "ip_filter.tsv found"
            head -3 ip_filter.tsv
          else
            echo "ERROR: ip_filter.tsv not found!"
            ls -la
            exit 1
          fi

      - name: Clean build directory
        run: rm -rf build

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Configure CMake
        run: cmake -S . -B build

      - name: Build project
        run: cmake --build build --config Release

      - name: Create Linux release package
        run: |
          mkdir linux-package
          cp build/laboratory2 linux-package/
          cp ip_filter.tsv linux-package/
          chmod +x linux-package/laboratory2
          echo "Linux release package created"

      - name: List Linux release contents
        run: ls -la linux-package/

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-package
          path: linux-package/

  create-release:
    needs: [build-windows, build-linux]  
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' 
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: windows-package
          path: windows-package

      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: linux-package
          path: linux-package

      - name: Debug - List all files
        run: |
          echo "=== Full file structure ==="
          find . -type f -name "*laboratory2*" -o -name "*ip_filter*" -o -name "*.exe" -o -name "*.tsv"
          echo "=== Windows package ==="
          find windows-package -type f
          echo "=== Linux package ==="
          find linux-package -type f

      - name: Verify exact file names
        run: |
          echo "=== Exact file names ==="
          ls -la windows-package/
          ls -la linux-package/
          
          echo "Checking for laboratory2.exe..."
          if [ -f "windows-package/laboratory2.exe" ]; then
            echo "✓ laboratory2.exe found"
          else
            echo "✗ laboratory2.exe NOT found"
            find windows-package -name "*.exe"
          fi
          
          echo "Checking for laboratory2 (Linux)..."
          if [ -f "linux-package/laboratory2" ]; then
            echo "✓ laboratory2 found"
          else
            echo "✗ laboratory2 NOT found"
            find linux-package -name "laboratory2"
          fi
          
          echo "Checking for ip_filter.tsv..."
          if [ -f "windows-package/ip_filter.tsv" ] && [ -f "linux-package/ip_filter.tsv" ]; then
            echo "✓ ip_filter.tsv found in both packages"
          else
            echo "✗ ip_filter.tsv missing"
            find . -name "ip_filter.tsv"
          fi

      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Release v${{ github.run_number }} 
          draft: false
          prerelease: false
          files: |
            windows-package/laboratory2.exe
            windows-package/ip_filter.tsv
            linux-package/laboratory2
            linux-package/ip_filter.tsv
          body: |
            ## Laboratory 2 Release v${{ github.run_number }}
            
            ### Windows:
            Download both files:
            - `laboratory2.exe` - Main executable
            - `ip_filter.tsv` - Data file
            
            Place them in the same folder and run `laboratory2.exe`
            
            ### Linux:
            Download both files:
            - `laboratory2` - Main executable  
            - `ip_filter.tsv` - Data file
            
            Make executable: `chmod +x laboratory2`
            Then run: `./laboratory2`